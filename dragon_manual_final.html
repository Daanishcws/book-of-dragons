<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dragon Manual of Berk</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=MedievalSharp&family=Cinzel:wght@400;600;700&family=IM+Fell+English:ital@0;1&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'IM Fell English', serif;
            background: linear-gradient(135deg, #2c1810 0%, #1a0f08 100%);
            color: #d4c5a9;
            min-height: 100vh;
            padding: 2rem;
            position: relative;
            overflow-x: hidden;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: 
                repeating-linear-gradient(90deg, transparent, transparent 2px, rgba(212, 197, 169, 0.03) 2px, rgba(212, 197, 169, 0.03) 4px),
                repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(212, 197, 169, 0.03) 2px, rgba(212, 197, 169, 0.03) 4px);
            pointer-events: none;
            z-index: 1;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            position: relative;
            z-index: 2;
        }

        header {
            text-align: center;
            margin-bottom: 3rem;
            padding: 2rem;
            background: rgba(42, 26, 26, 0.5);
            border: 3px solid #8b7355;
            border-radius: 10px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
        }

        h1 {
            font-family: 'MedievalSharp', cursive;
            font-size: 3.5rem;
            color: #f4e4bc;
            text-shadow: 3px 3px 6px rgba(0, 0, 0, 0.8);
            margin-bottom: 0.5rem;
            letter-spacing: 3px;
        }

        .subtitle {
            font-family: 'Cinzel', serif;
            font-size: 1.2rem;
            color: #b89968;
            font-style: italic;
            letter-spacing: 2px;
        }

        .instructions {
            background: rgba(139, 69, 19, 0.3);
            border: 2px solid #8b4513;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            color: #f4e4bc;
        }

        .instructions h3 {
            font-family: 'Cinzel', serif;
            color: #f4e4bc;
            margin-bottom: 1rem;
        }

        .instructions ul {
            margin-left: 1.5rem;
            line-height: 1.8;
        }

        .instructions code {
            background: rgba(0, 0, 0, 0.3);
            padding: 0.2rem 0.5rem;
            border-radius: 3px;
            font-family: monospace;
            color: #9CAF3B;
        }

        .dragon-list {
            background: rgba(42, 26, 26, 0.6);
            border: 2px solid #8b7355;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            max-height: 300px;
            overflow-y: auto;
        }

        .dragon-item {
            background: rgba(212, 197, 169, 0.1);
            padding: 1rem;
            margin-bottom: 0.8rem;
            border-radius: 5px;
            border-left: 4px solid #8b7355;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
        }

        .dragon-item:hover {
            background: rgba(212, 197, 169, 0.2);
            transform: translateX(5px);
        }

        .dragon-name {
            font-family: 'Cinzel', serif;
            font-weight: 600;
            font-size: 1.1rem;
            color: #f4e4bc;
        }

        .dragon-class {
            font-size: 0.9rem;
            color: #b89968;
            font-style: italic;
        }

        .btn-remove {
            background: #8b4513;
            color: #f4e4bc;
            border: none;
            padding: 0.4rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            font-family: 'Cinzel', serif;
            transition: all 0.3s ease;
        }

        .btn-remove:hover {
            background: #a0522d;
            transform: scale(1.05);
        }

        .form-section {
            background: rgba(42, 26, 26, 0.7);
            border: 3px solid #8b7355;
            border-radius: 10px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.4);
        }

        .form-title {
            font-family: 'Cinzel', serif;
            font-size: 1.8rem;
            color: #f4e4bc;
            margin-bottom: 1.5rem;
            text-align: center;
            border-bottom: 2px solid #8b7355;
            padding-bottom: 0.5rem;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        label {
            font-family: 'Cinzel', serif;
            font-size: 1rem;
            color: #f4e4bc;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }

        input[type="text"],
        select,
        textarea {
            background: rgba(212, 197, 169, 0.1);
            border: 2px solid #8b7355;
            border-radius: 5px;
            padding: 0.8rem;
            font-family: 'IM Fell English', serif;
            font-size: 1rem;
            color: #f4e4bc;
            transition: all 0.3s ease;
        }

        /* Fix dropdown text color */
        select option {
            background: #2c1810;
            color: #f4e4bc;
        }

        input[type="text"]:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: #b89968;
            background: rgba(212, 197, 169, 0.15);
            box-shadow: 0 0 10px rgba(184, 153, 104, 0.3);
        }

        textarea {
            resize: vertical;
            min-height: 120px;
            line-height: 1.6;
        }

        select {
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23f4e4bc' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 1rem center;
            padding-right: 2.5rem;
        }

        .button-group {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-top: 2rem;
        }

        .btn-primary,
        .btn-secondary {
            font-family: 'Cinzel', serif;
            font-size: 1.1rem;
            padding: 1rem 2.5rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            letter-spacing: 1px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
        }

        .btn-primary {
            background: linear-gradient(135deg, #8b4513 0%, #654321 100%);
            color: #f4e4bc;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #a0522d 0%, #8b4513 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.6);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #556b2f 0%, #3d4f1f 100%);
            color: #f4e4bc;
        }

        .btn-secondary:hover {
            background: linear-gradient(135deg, #6b8e23 0%, #556b2f 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.6);
        }

        .empty-state {
            text-align: center;
            padding: 2rem;
            color: #b89968;
            font-style: italic;
        }

        @media (max-width: 768px) {
            h1 {
                font-size: 2.5rem;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .button-group {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Dragon Manual of Berk</h1>
            <p class="subtitle">~ Record your discoveries of dragonkind ~</p>
        </header>

        <div class="dragon-list" id="dragonList">
            <div class="empty-state">No dragons recorded yet. Add your first dragon below!</div>
        </div>

        <div class="form-section">
            <h2 class="form-title">Record a New Dragon</h2>
            <form id="dragonForm">
                <div class="form-row">
                    <div class="form-group">
                        <label for="dragonName">Dragon Name *</label>
                        <input type="text" id="dragonName" required>
                    </div>
                    <div class="form-group">
                        <label for="dragonClass">Dragon Class *</label>
                        <select id="dragonClass" required>
                            <option value="">Select a class...</option>
                            <option value="stoker">Stoker Class</option>
                            <option value="boulder">Boulder Class</option>
                            <option value="tracker">Tracker Class</option>
                            <option value="sharp">Sharp Class</option>
                            <option value="tidal">Tidal Class</option>
                            <option value="mystery">Mystery Class</option>
                            <option value="strike">Strike Class</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="dragonSize">Size Category *</label>
                        <select id="dragonSize" required>
                            <option value="">Select size...</option>
                            <option value="Tiny">Tiny</option>
                            <option value="Small">Small</option>
                            <option value="Medium">Medium</option>
                            <option value="Large">Large</option>
                            <option value="Huge">Huge</option>
                            <option value="Colossal">Colossal</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="dragonHabitat">Habitat *</label>
                        <select id="dragonHabitat" required>
                            <option value="">Select habitat...</option>
                            <option value="Mountains">Mountains</option>
                            <option value="Forests">Forests</option>
                            <option value="Caves">Caves</option>
                            <option value="Oceans">Oceans</option>
                            <option value="Deserts">Deserts</option>
                            <option value="Volcanic Regions">Volcanic Regions</option>
                            <option value="Arctic">Arctic</option>
                            <option value="Swamps">Swamps</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                </div>

                <div class="form-row" id="otherHabitatRow" style="display: none;">
                    <div class="form-group full-width">
                        <label for="otherHabitat">Specify Other Habitat</label>
                        <input type="text" id="otherHabitat">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="dragonDiet">Diet *</label>
                        <select id="dragonDiet" required>
                            <option value="">Select diet...</option>
                            <option value="Carnivore">Carnivore</option>
                            <option value="Herbivore">Herbivore</option>
                            <option value="Omnivore">Omnivore</option>
                            <option value="specialized">Specialized</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="dragonDanger">Danger Level *</label>
                        <select id="dragonDanger" required>
                            <option value="">Select danger level...</option>
                            <option value="Harmless">Harmless</option>
                            <option value="Low Threat">Low Threat</option>
                            <option value="Moderate Threat">Moderate Threat</option>
                            <option value="Dangerous">Dangerous</option>
                            <option value="Extremely Dangerous">Extremely Dangerous</option>
                            <option value="Legendary Threat">Legendary Threat</option>
                        </select>
                    </div>
                </div>

                <div class="form-row" id="dietDetailsRow" style="display: none;">
                    <div class="form-group full-width">
                        <label for="dietDetails">Diet Details</label>
                        <input type="text" id="dietDetails" placeholder="Specify what this dragon consumes...">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group full-width">
                        <label for="dragonWeakness">Known Weaknesses *</label>
                        <input type="text" id="dragonWeakness" required placeholder="Enter observed weaknesses...">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group full-width">
                        <label for="dragonDescription">Physical Description *</label>
                        <textarea id="dragonDescription" required placeholder="Describe the appearance of this beast..."></textarea>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group full-width">
                        <label for="dragonBehavior">Behavioral Traits *</label>
                        <textarea id="dragonBehavior" required placeholder="Describe the behavior observed in the wild..."></textarea>
                    </div>
                </div>

                <div class="button-group">
                    <button type="submit" class="btn-primary">Add Dragon to Manual</button>
                    <button type="button" class="btn-secondary" id="generatePDF">Preview PDF in New Tab</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const dragons = [];
        const classLabels = {
            stoker: 'Stoker Class',
            boulder: 'Boulder Class',
            tracker: 'Tracker Class',
            sharp: 'Sharp Class',
            tidal: 'Tidal Class',
            mystery: 'Mystery Class',
            strike: 'Strike Class'
        };

        const classColors = {
            stoker: '#C41E3A',
            boulder: '#8B4513',
            tracker: '#9CAF3B',
            sharp: '#2E8B57',
            tidal: '#1E5A8E',
            mystery: '#8B008B',
            strike: '#C71585'
        };

        const iconPaths = {
            stoker: 'icons/stoker.jpg',
            boulder: 'icons/boulder.jpg',
            tracker: 'icons/tracker.jpg',
            sharp: 'icons/sharp.jpg',
            tidal: 'icons/tidal.jpg',
            mystery: 'icons/mystery.jpg',
            strike: 'icons/strike.jpg'
        };

        // Show/hide conditional fields
        document.getElementById('dragonHabitat').addEventListener('change', function() {
            document.getElementById('otherHabitatRow').style.display = 
                this.value === 'other' ? 'grid' : 'none';
        });

        document.getElementById('dragonDiet').addEventListener('change', function() {
            document.getElementById('dietDetailsRow').style.display = 
                this.value === 'specialized' ? 'grid' : 'none';
        });

        // Form submission
        document.getElementById('dragonForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const habitat = document.getElementById('dragonHabitat').value === 'other' 
                ? document.getElementById('otherHabitat').value 
                : document.getElementById('dragonHabitat').value;
            
            let diet = document.getElementById('dragonDiet').value;
            if (diet === 'specialized') {
                diet = document.getElementById('dietDetails').value || 'Specialized';
            }

            const dragon = {
                name: document.getElementById('dragonName').value,
                class: document.getElementById('dragonClass').value,
                size: document.getElementById('dragonSize').value,
                habitat: habitat,
                diet: diet,
                danger: document.getElementById('dragonDanger').value,
                weakness: document.getElementById('dragonWeakness').value,
                description: document.getElementById('dragonDescription').value,
                behavior: document.getElementById('dragonBehavior').value
            };

            dragons.push(dragon);
            updateDragonList();
            this.reset();
            document.getElementById('otherHabitatRow').style.display = 'none';
            document.getElementById('dietDetailsRow').style.display = 'none';
        });

        function updateDragonList() {
            const listDiv = document.getElementById('dragonList');
            
            if (dragons.length === 0) {
                listDiv.innerHTML = '<div class="empty-state">No dragons recorded yet. Add your first dragon below!</div>';
                return;
            }

            listDiv.innerHTML = dragons.map((dragon, index) => `
                <div class="dragon-item">
                    <div>
                        <div class="dragon-name">${dragon.name}</div>
                        <div class="dragon-class">${classLabels[dragon.class]}</div>
                    </div>
                    <button class="btn-remove" onclick="removeDragon(${index})">Remove</button>
                </div>
            `).join('');
        }

        function removeDragon(index) {
            dragons.splice(index, 1);
            updateDragonList();
        }

        // Load image as base64
        async function loadImageAsBase64(path) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.crossOrigin = 'anonymous';
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    canvas.width = img.width;
                    canvas.height = img.height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0);
                    const dataURL = canvas.toDataURL('image/jpeg');
                    resolve(dataURL);
                };
                img.onerror = function() {
                    console.warn(`Could not load icon: ${path}`);
                    resolve(null);
                };
                img.src = path;
            });
        }

        // PDF Generation with preview
        document.getElementById('generatePDF').addEventListener('click', async function() {
            if (dragons.length === 0) {
                alert('Add at least one dragon before generating the manual!');
                return;
            }

            // Preload all icons
            const iconCache = {};
            for (const [classKey, iconPath] of Object.entries(iconPaths)) {
                iconCache[classKey] = await loadImageAsBase64(iconPath);
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            for (let i = 0; i < dragons.length; i++) {
                if (i > 0) doc.addPage();
                await generateDragonPage(doc, dragons[i], iconCache);
            }

            // Open in new tab instead of downloading
            const pdfBlob = doc.output('blob');
            const pdfUrl = URL.createObjectURL(pdfBlob);
            window.open(pdfUrl, '_blank');
        });

        function wrapText(text, maxCharsPerLine) {
            const words = text.split(' ');
            const lines = [];
            let currentLine = '';

            words.forEach(word => {
                const testLine = currentLine ? `${currentLine} ${word}` : word;
                if (testLine.length > maxCharsPerLine) {
                    if (currentLine) lines.push(currentLine);
                    currentLine = word;
                } else {
                    currentLine = testLine;
                }
            });
            
            if (currentLine) lines.push(currentLine);
            return lines;
        }

        async function generateDragonPage(doc, dragon, iconCache) {
            const pageWidth = 210;
            const pageHeight = 297;
            
            // White background
            doc.setFillColor(255, 255, 255);
            doc.rect(0, 0, pageWidth, pageHeight, 'F');

            // Title - larger and properly positioned
            doc.setTextColor(42, 26, 26);
            doc.setFontSize(36);
            doc.setFont('Helvetica', 'bold');
            const titleWidth = doc.getTextWidth(dragon.name);
            doc.text(dragon.name, (pageWidth - titleWidth) / 2, 30);

            // Wavy underline
            doc.setDrawColor(42, 26, 26);
            doc.setLineWidth(0.8);
            doc.line((pageWidth - titleWidth) / 2 - 5, 33, (pageWidth + titleWidth) / 2 + 5, 33);

            // Add actual class icon image or fallback to circle
            const iconX = pageWidth / 2;
            const iconY = 60;
            const iconSize = 40;
            
            const iconData = iconCache[dragon.class];
            if (iconData) {
                try {
                    // Add the actual icon image
                    doc.addImage(iconData, 'JPEG', iconX - iconSize/2, iconY - iconSize/2, iconSize, iconSize);
                } catch (e) {
                    console.warn('Could not add icon to PDF, using fallback:', e);
                    // Fallback to circle if image fails
                    drawFallbackIcon(doc, dragon, iconX, iconY);
                }
            } else {
                // No icon loaded, use fallback
                drawFallbackIcon(doc, dragon, iconX, iconY);
            }

            // Class name
            doc.setTextColor(42, 26, 26);
            doc.setFontSize(16);
            doc.setFont('Helvetica', 'italic');
            const className = classLabels[dragon.class];
            const classWidth = doc.getTextWidth(className);
            doc.text(className, (pageWidth - classWidth) / 2, 88);

            // Stats - bigger font and better spacing
            let yPos = 105;
            doc.setFontSize(13);
            doc.setTextColor(59, 47, 47);
            
            const stats = [
                ['Size:', `${dragon.size}`],
                ['Habitat:', dragon.habitat],
                ['Diet:', dragon.diet],
                ['Danger:', dragon.danger],
                ['Weakness:', dragon.weakness]
            ];

            stats.forEach(([label, value]) => {
                doc.setFont('Helvetica', 'italic');
                doc.text(label, 25, yPos);
                doc.setFont('Helvetica', 'normal');
                const wrappedValue = wrapText(value, 60);
                wrappedValue.forEach((line, idx) => {
                    doc.text(line, 55, yPos + (idx * 6));
                });
                yPos += (wrappedValue.length * 6) + 3;
            });

            // Divider
            yPos += 8;
            doc.setLineWidth(0.8);
            doc.setDrawColor(139, 115, 85);
            doc.line(20, yPos, pageWidth - 20, yPos);
            yPos += 12;

            // Physical Description
            doc.setFontSize(14);
            doc.setFont('Helvetica', 'italic');
            doc.setTextColor(42, 26, 26);
            doc.text('Appearance as witnessed:', 25, yPos);
            yPos += 8;

            doc.setFont('Helvetica', 'normal');
            doc.setFontSize(12);
            doc.setTextColor(59, 47, 47);
            const descLines = wrapText(dragon.description, 75);
            descLines.forEach(line => {
                if (yPos > 260) return;
                doc.text(line, 25, yPos);
                yPos += 6;
            });

            // Behavioral Traits
            yPos += 8;
            doc.setFontSize(14);
            doc.setFont('Helvetica', 'italic');
            doc.setTextColor(42, 26, 26);
            doc.text('Behavior observed in the wild:', 25, yPos);
            yPos += 8;

            doc.setFont('Helvetica', 'normal');
            doc.setFontSize(12);
            doc.setTextColor(59, 47, 47);
            const behaviorLines = wrapText(dragon.behavior, 75);
            behaviorLines.forEach(line => {
                if (yPos > 275) return;
                doc.text(line, 25, yPos);
                yPos += 6;
            });
        }

        function drawFallbackIcon(doc, dragon, iconX, iconY) {
            const iconRadius = 18;
            const classColor = classColors[dragon.class];
            const rgb = hexToRgb(classColor);
            
            doc.setFillColor(rgb.r, rgb.g, rgb.b);
            doc.circle(iconX, iconY, iconRadius, 'F');
            
            doc.setDrawColor(59, 47, 47);
            doc.setLineWidth(1.2);
            doc.circle(iconX, iconY, iconRadius, 'S');

            doc.setTextColor(255, 255, 255);
            doc.setFontSize(32);
            doc.setFont('Helvetica ', 'bold');
            const initial = classLabels[dragon.class].charAt(0);
            const initialWidth = doc.getTextWidth(initial);
            doc.text(initial, iconX - initialWidth / 2, iconY + 8);
        }

        function hexToRgb(hex) {
            const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? {
                r: parseInt(result[1], 16),
                g: parseInt(result[2], 16),
                b: parseInt(result[3], 16)
            } : { r: 0, g: 0, b: 0 };
        }
    </script>
</body>
</html>
